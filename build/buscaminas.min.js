const mines=[1,40,99,150,1e3],dimensionsR=[9,16,16,30,100],dimensionsC=[9,16,30,30,100];let model,oldModel,styles,timerInterval,myApp;function init(e){myApp=e,model={tablero:[[{class:"Suelo",type:"Agua",pulsada:!1,vec:1,row:0,col:0},{class:"Losa",type:"Agua",pulsada:!1,vec:1,row:0,col:1}],[{class:"Losa",type:"Mina",pulsada:!1,vec:2,row:1,col:0},{class:"Losa",type:"Mina",pulsada:!1,vec:2,row:1,col:1}]],aguas:81,estado:"Juego",size:10,rows:9,cols:9,minas:10,horaInicio:"SinInicio"},update(null,"","","Increase")}let randomInt=e=>Math.floor(Math.random()*e),randCoordsGen=(e,i)=>({col:randomInt(i),row:randomInt(e)}),encode=e=>e.row+"."+e.col,filasVec=(e,i)=>(0<e?[e-1,e]:[e]).concat(e<i-1?[e+1]:[]),colsVec=(e,i)=>(0<e?[e-1,e]:[e]).concat(e<i-1?[e+1]:[]),vecinos=(o,t,a)=>filasVec(t,o.length).flatMap(i=>colsVec(a,o[0].length).filter(e=>!(e==a&&i==t)).map(e=>o[i][e])),minasVecinas=(e,i,o)=>vecinos(e,i,o).filter(e=>"Mina"==e.type),losasVecinas=(e,i,o)=>vecinos(e,i,o).filter(esLosa),losasVaciasVecinas=(e,i,o)=>vecinos(e,i,o).filter(e=>"Losa"==e.class),esAgua=e=>!~["Mina","Expl","minaDesactivada","notMina"].indexOf(e.class),esIcono=e=>!!~["Mina","Expl","maybeMina","minaDesactivada","notMina"].indexOf(e.class),esLosa=e=>!!~["Losa","maybeMina"].indexOf(e.class),descubiertas=e=>e.tablero.flatMap(e=>e.filter(e=>"Agua"==e.type&&"Agua"==e.class)).length;function initTablero(){model.estado="Juego",model.horaInicio="SinInicio",model.minas=mines[model.size],model.rows=dimensionsR[model.size],model.cols=dimensionsC[model.size],model.aguas=model.rows*model.cols-model.minas;let o={},t=(Array(model.minas).fill().map(()=>{let e=randCoordsGen(model.rows,model.cols),i=encode(e);for(;null!=o[i]&&null!=o[i]&&0==e.col&&0==e.row;)e=randCoordsGen(model.rows,model.cols),i=encode(e);return o[i]=e,i}),[]);for(let i=0;i<model.rows;i++){var a=[];for(let e=0;e<model.cols;e++){var n=o[encode({row:i,col:e})];a.push(null!=n?{class:"Losa",type:"Mina",vec:0,row:i,col:e,pulsada:!1}:{class:"Losa",type:"Agua",vec:0,row:i,col:e,pulsada:!1})}t.push(a)}return t=t.map((e,o)=>e.map((e,i)=>(e.vec=minasVecinas(t,o,i).length,e)))}function update(i,o,t,e){if(oldModel=JSON.parse(JSON.stringify(model)),"Increase"==e)model.size=model.size<mines.length-1?model.size+1:0,model.tablero=initTablero(),view();else if("Start"==e)model.tablero=initTablero(),view();else if("Timer"==e){var a=document.getElementById("ms-temp"),n=document.getElementsByClassName("ms-top-panel")[0];n.removeChild(a),n.appendChild(viewTemporizador())}else if("SueloDown"==e)pulsarLosasVecinas(o,t),view();else if("SueloUp"==e)2===i.detail&&(descubrirLosaVecinasSiMinasMarcadas(o,t),view());else if("ClickLosa"==e){"SinInicio"==model.horaInicio&&(model.horaInicio=new Date,timerInterval=setInterval(()=>{update(null,null,null,"Timer")},1e3));let e=!1;3===i.which&&(e=!0,i.preventDefault());a=model.tablero[o][t];(e?toggleBandera:descubrirCasilla)(a),view()}}function descubrirCasilla(e){"Losa"==e.class&&(e.pulsada=!1,e.class=e.type,"Agua"==e.type?(0==e.vec&&propagar(e.row,e.col),descubiertas(model)==model.aguas&&(model.estado="Victoria",lanzarConfeti())):"Mina"==e.type&&(model.estado="Derrota",e.class="Expl"),"Juego"!=model.estado)&&descubrirTablero()}function toggleBandera(e){switch(e.class){case"Losa":e.class="maybeMina",--model.minas;break;case"maybeMina":e.class="Losa",model.minas+=1}}function propagar(e,i){losasVecinas(model.tablero,e,i).filter(e=>"Agua"==e.type).forEach(e=>{var i=model.tablero[e.row][e.col];i.class=i.type,0==i.vec&&propagar(e.row,e.col)})}function descubrirTablero(){clearInterval(timerInterval),timerInterval=0,model.tablero=model.tablero.map(e=>e.map(e=>(e.class="maybeMina"==e.class&&"Mina"==e.type?"minaDesactivada":"maybeMina"==e.class&&"Agua"==e.type?"notMina":"Expl"==e.class?"Expl":e.type,e)))}function pulsarLosasVecinas(e,i){losasVaciasVecinas(model.tablero,e,i).forEach(e=>{model.tablero[e.row][e.col].pulsada=!0}),document.addEventListener("mouseup",()=>{losasVecinas(model.tablero,e,i).forEach(e=>{model.tablero[e.row][e.col].pulsada=!1}),view()},{once:!0})}function descubrirLosaVecinasSiMinasMarcadas(e,i){var o=model.tablero[e][i],e=losasVecinas(model.tablero,e,i);o.vec==e.filter(e=>"maybeMina"==e.class).length&&e.filter(e=>"Losa"==e.class).forEach(e=>{descubrirCasilla(e)})}function view(){var e=document.getElementById("buscaminas");e.innerHTML="",oldModel&&model.rows==oldModel.rows&&model.cols==oldModel.cols&&model.size==oldModel.size||viewStyles(),e.appendChild(viewTopPanel()),e.appendChild(viewTablero())}function viewStyles(){null!=styles&&document.head.removeChild(styles),(styles=document.createElement("style")).innerHTML=css(),document.head.appendChild(styles)}function viewTopPanel(){var e=document.createElement("section");return e.className="ms-top-panel",e.appendChild(viewContador()),e.appendChild(viewBotonIncrease()),e.appendChild(viewBotonStart()),e.appendChild(viewTemporizador()),e}function viewTemporizador(){var e,i,o,t,a,n=viewPanelNumerico();return n.style.minWidth="300px",n.id="ms-temp","SinInicio"==model.horaInicio?n.innerHTML=[0,0,":",0,0,":",0,0].map(e=>":"==e?"<div class='divider sec'>:</div>":viewDigito(e)).join(""):(o=new Date-model.horaInicio,e=Math.floor(o/1e3)%60,i=Math.floor(o/6e4)%60,n.innerHTML=[(t=e=>e<10?0:Math.floor(e/10))(o=Math.floor(o/36e5)%24),(a=e=>e<10?e:e%10)(o),":",t(i),a(i),":",t(e),a(e)].map(e=>":"==e?"<div class='divider sec'>:</div>":viewDigito(e)).join("")),n}function viewContador(){var e=viewPanelNumerico(),i=(e.id="ms-count",e.style.minWidth="180px",model.minas%10),o=(model.minas-i)%100/10,t=(model.minas-i-10*o)%1e3/100,a=(model.minas-i-10*o-100*t)%1e4/1e3;return e.innerHTML=[i,o,t,a].reverse().map(viewDigito).join(""),e}function viewPanelNumerico(){var e=document.createElement("section");return e.className="ms-panel",e.style.backgroundColor="#111111",e.style.width="fit-content",e.style.borderRadius="4px",e.style.borderColor="aliceblue",e.style.borderWidth="revert",e.style.borderStyle="double",e}function viewDigito(e){return`    
            <div class='digit ${["zero","one","two","three","four","five","six","seven","eight","nine"][e]}'>
            <div class='unit'></div>
            <div class='unit'></div>
            <div class='unit'></div>
            <div class='unit'></div>
            <div class='unit'></div>
            <div class='unit'></div>
            <div class='unit'></div>
            </div>
        `}function viewBotonIncrease(){var e=document.createElement("input");return e.value="Increase",buttonStyle(e),e.onclick=()=>update(null,null,null,"Increase"),e}function viewBotonStart(){var e=document.createElement("input");return e.value="Start",buttonStyle(e),e.onclick=()=>update(null,null,null,"Start"),e}function buttonStyle(e){e.style.width="95px",e.style.height="50px",e.style.margin="10px",e.style.color="black",e.type="button",e.style.backgroundColor="#77777"}function viewTablero(){let o=document.createElement("section");return o.className="ms-tablero",model.tablero.forEach((e,i)=>{o.appendChild(viewFila(e,i))}),o}function viewFila(e,o){let t=document.createElement("ul");return t.className="ms-fila",e.forEach((e,i)=>{t.appendChild(viewCasilla(e,o,i))}),t}function viewCasilla(e,i,o){var t,a=document.createElement("li");return a.classList="ms-"+(esLosa(e)?"Losa":"Suelo"),esLosa(e)&&e.pulsada&&(a.classList+=" ms-Losa_Pulsada"),!esLosa(e)&&esAgua(e)&&0<e.vec&&!e.pulsada&&(a.classList+=" ms-"+e.vec,a.innerText=e.vec),esIcono(e)&&((t=document.createElement("div")).className="ms-"+e.class,a.appendChild(t)),esLosa(e)?(a.addEventListener("mouseup",e=>{update(e,i,o,"ClickLosa")}),a.addEventListener("contextmenu",e=>(e.preventDefault(),!1),!1)):(a.addEventListener("mouseup",e=>{update(e,i,o,"SueloUp")}),a.addEventListener("mousedown",e=>{update(e,i,o,"SueloDown")}),a.addEventListener("contextmenu",e=>{e.preventDefault()},!1)),a}function lanzarConfeti(){let i=document.getElementsByClassName("ms-tablero")[0].getBoundingClientRect();for(let e=0;e<8;e++)setTimeout(()=>myApp.ports.messageReceiver.send(JSON.stringify({x:Math.floor(i.x+i.width/8*e),y:Math.floor(i.y+100+randomInt(i.height/2)),direction:Math.floor(5*e-47),action:"Victory"})),60*e),setTimeout(()=>myApp.ports.messageReceiver.send(JSON.stringify({x:Math.floor(i.x+i.width/8*(8-e)),y:Math.floor(i.y+100+randomInt(i.height/2)),direction:Math.floor(47-5*e),action:"Victory"})),60*e)}function css(){return`
*,
*:before,
*:after {
    position: relative;
    box-sizing: border-box;
}

.ms-buscaminas {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.ms-top-panel{
    display: flex;
    min-width: px;
    flex-direction: row;
}

.ms-tablero {
    user-select: none; 
    display: flex;
    flex-direction: column;
    margin: unset;

    max-height:  ${50*model.rows+60}px;
    max-width:  ${50*model.cols+60}px;

    background-size: cover; 
    overflow: hidden;
    background-repeat: no-repeat;
    background-position: center center;
    background-image: url('/assets/cats.jpg');

    border-style: groove;
    border-width: 15px;
    padding: 15px;
}

.ms-tablero > ul {
    list-style-type: none;
    padding-inline-start: unset;
    margin: unset;
}

.ms-fila{
    display: flex;
    flex-direction: row;
    margin: unset;

}

.ms-Losa, .ms-Suelo {
    min-height:  50px;
    min-width:  50px;
    font-size: 1.5em;
    text-align: center;
    background-size: contain;
    background-position: center center;
}

.ms-Losa {
    background-image: url( '/assets/casillavacia.svg' );
    /* background-image: url( '/assets/casillavacia.svg' ); */
}

.ms-Losa_hover {
    background-image: url( '/assets/casillavacia.svg' );
    transition: 0s background-image;
}

.ms-Losa_hover:hover {
    background-image: url( '/assets/casillavaciaPulsada.svg' );
    transition-delay:0.3s;
}

.ms-Losa_Pulsada{
    background-image: url( '/assets/casillavaciaPulsada.svg' );
}

.ms-Suelo {
    background-image: url( '/assets/casillavaciadw.svg' );
    /* background-image: url( '/assets/casillavaciadw.svg' ); */
} 

.ms-Mina, .ms-Expl, .ms-maybeMina, .ms-notMina, .ms-minaDesactivada {
    height:  100%;
    width:  100%;
    font-size: 1.5em;
    text-align: center;
    background-size: contain;
    background-position: center center;
    z-index: 10;
    position: absolute;
}

.ms-Mina {
    background-image: url( '/assets/bomba.svg' );
} 

.ms-Expl {
    background-image: url( '/assets/bombaExpl.svg' );
} 

.ms-maybeMina {
    background-image: url( '/assets/maybeBomba.svg' );
} 

.ms-notMina {
    background-image: url( '/assets/notBomba.svg' );
} 

.ms-minaDesactivada {
    background-image: url( '/assets/bombaDesactivada.svg' );
} 

.ms-1, .ms-2, .ms-3, .ms-4 ,.ms-5, .ms-6,.ms-7,.ms-8{
    padding-top: 0;
}
.ms-1{
    color:rgb(41, 41, 212);
}
.ms-2{
    color:darkgreen;
}
.ms-3{
    color: red;
}
.ms-4{
    color:rgb(3, 3, 90);
}
.ms-5{
   color: darkmagenta
}
.ms-6{
    filter: darkorchid;
}
.ms-7{
    color: greenyellow;
}
.ms-8{
    color: coral;
}
    `+`
      button {
        border: 0;
        background: #369;
        color: #FFF;
        border-radius: 0.25em;
        padding: 0.5em 1em;
        font-size: 1.2em;
      }
      button:hover {
        background: #264d73;
      }
      button:active {
        background: #996633;
      }
      
      .unit::after, .unit::before, .icon-expand, .triangle-nw, .triangle-sw, .triangle-se, .triangle-ne, .triangle-w, .triangle-s, .triangle-e, .triangle-n, .triangle-n-equal {
        display: inline-block;
        height: 0;
        width: 0;
        padding: 0;
        overflow: hidden;
        text-indent: 100%;
        border-style: solid;
        border-color: transparent;
      }
      
      /*       * NOTE: height and width are that of the bounding box, not the triangle!
      */
      .triangle-n-equal {
        border-width: 0 3em 5.196em;
        border-bottom-color: #333;
      }
      
      .triangle-n {
        border-width: 0 0.5em 1em;
        border-bottom-color: #f00;
      }
      
      .triangle-e {
        border-width: 0.5em 0 0.5em 1em;
        border-left-color: #f00;
      }
      
      .triangle-s {
        border-width: 1em 0.5em 0;
        border-top-color: #f00;
      }
      
      .triangle-w {
        border-width: 0.5em 1em 0.5em 0;
        border-right-color: #f00;
      }
      
      .triangle-ne {
        border-width: 1em 0 0 1em;
        border-top-color: #f00;
      }
      
      .triangle-se {
        border-width: 0 0 1em 1em;
        border-bottom-color: #f00;
      }
      
      .triangle-sw {
        border-width: 0 1em 1em 0;
        border-bottom-color: #f00;
      }
      
      .triangle-nw {
        border-width: 1em 1em 0 0;
        border-top-color: #f00;
      }
      
      .icon-expand {
        border-width: 0.375em 0 0.375em 0.5em;
        border-left-color: #fff;
        transition: all 0.5s;
      }
      button:active .icon-expand {
        transform: rotateZ(90deg);
      }
      
      html {
        background: #666;
      }
      
      #debug {
        color: #0f0;
      }
      
      .divider {
        color: #0f0;
        font-size: 1.2em;
        float: left;
        margin-top: 10px;
        margin-left: 0;
        margin-right: 0;
        /*
        Tried pulsing the divider on the corresponding time interval but didn't like it.
        &.sec {
          animation: pulse .5s ease-out infinite both alternate;
        }
        &.min {
          animation: pulse 30s ease-out infinite both alternate;
        }
        */
      }
      
      @keyframes pulse {
        from {
          opacity: 1;
        }
        to {
          opacity: 0.1;
        }
      }
      .digit {
        margin: 0.5em 0.3em 0.3em 0.4em;
        position: relative;
        float: left;
        width: 1.1em;
        height: 1.9em;
      }
      .digit .unit:nth-child(2n) {
        transform: rotateZ(90deg);
        left: 0.4em;
      }
      .digit .unit:nth-child(1) {
        top: 0.05em;
        left: 0;
      }
      .digit .unit:nth-child(7) {
        top: 0.05em;
        left: 0.8em;
      }
      .digit .unit:nth-child(3) {
        top: 0.85em;
        left: 0;
      }
      .digit .unit:nth-child(5) {
        top: 0.85em;
        left: 0.8em;
      }
      .digit .unit:nth-child(2) {
        top: -0.35em;
      }
      .digit .unit:nth-child(4) {
        top: 0.45em;
      }
      .digit .unit:nth-child(6) {
        top: 1.25em;
      }
      .digit.zero .unit:nth-child(4n), .digit.one .unit:nth-child(1),
      .digit.one .unit:nth-child(3),
      .digit.one .unit:nth-child(2),
      .digit.one .unit:nth-child(4),
      .digit.one .unit:nth-child(6), .digit.two .unit:nth-child(4n+1), .digit.three .unit:nth-child(1),
      .digit.three .unit:nth-child(3), .digit.four .unit:nth-child(2),
      .digit.four .unit:nth-child(3),
      .digit.four .unit:nth-child(6), .digit.five .unit:nth-child(4n+3), .digit.six .unit:nth-child(7n), .digit.seven .unit:nth-child(1),
      .digit.seven .unit:nth-child(3),
      .digit.seven .unit:nth-child(4),
      .digit.seven .unit:nth-child(6), .digit.nine .unit:nth-child(3n) {
        background: rgba(0, 255, 0, 0.1);
        color: rgba(0, 255, 0, 0.1);
        box-shadow: none;
      }
      
      .unit {
        position: absolute;
        top: 0;
        left: 0;
        width: 0.1em;
        height: 0.6em;
        background: #0f0;
        color: #0f0;
        box-shadow: 0 0 1em #0f0;
      }
      .unit::before {
        border-width: 0 0.05em 0.05em;
        border-bottom-color: inherit;
        content: "";
        position: absolute;
        top: -0.05em;
        left: 0;
      }
      .unit::after {
        border-width: 0.05em 0.05em 0;
        border-top-color: inherit;
        content: "";
        position: absolute;
        bottom: -0.05em;
        left: 0;
      }
      `}export{init};